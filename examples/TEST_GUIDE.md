# 测试程序使用指南

## 📋 概述

本目录包含三个测试程序，从简单到复杂，满足不同的测试需求。

## 🎯 测试程序对比

| 程序 | 文件 | 测试场景数 | 运行时间 | 适用场景 |
|------|------|-----------|---------|---------|
| 快速测试 | `quick-test.ts` | 9 个步骤 | ~10 秒 | 快速验证、演示 |
| 基础示例 | `basic-usage.ts` | 代码示例 | N/A | 学习参考 |
| 综合测试 | `comprehensive-test.ts` | 13 个场景 | ~60 秒 | 全面测试、性能评估 |

## 🚀 使用方法

### 1️⃣ 快速测试程序 (`quick-test.ts`)

**用途**: 最快速的功能验证

**测试内容**:
- ✅ SDK 初始化
- ✅ 用户注册
- ✅ 页面访问
- ✅ 点击事件
- ✅ 用户订阅
- ✅ 自定义事件
- ✅ 批量上报
- ✅ 手动刷新
- ✅ 资源清理

**运行**:
```bash
yarn example:quick
```

**输出示例**:
```
🚀 开始快速测试...

📦 步骤 1: 初始化 SDK
✅ SDK 初始化成功

📝 步骤 2: 用户注册
✅ 用户注册: user_1701234567890

🔍 步骤 3: 页面访问
✅ 页面访问追踪完成

...

🎉 快速测试完成！
```

### 2️⃣ 基础示例 (`basic-usage.ts`)

**用途**: 学习和参考代码

**包含内容**:
- 初始化配置示例
- 各类事件追踪代码
- 注释详细的示例代码

**使用**:
```bash
# 直接阅读代码
cat examples/basic-usage.ts

# 或运行查看效果
yarn example:basic
```

### 3️⃣ 综合测试程序 (`comprehensive-test.ts`)

**用途**: 全面功能测试和性能评估

**测试场景**:

#### 基础功能测试
1. **SDK 初始化** - 测试配置和初始化流程
2. **用户注册** - 测试注册事件追踪
3. **登录登出** - 测试用户认证流程
4. **订阅功能** - 测试多种订阅计划
5. **页面访问** - 测试多页面浏览追踪
6. **点击事件** - 测试多种点击场景
7. **自定义事件** - 测试业务自定义事件

#### 高级功能测试
8. **批量上报** - 验证批量发送机制
9. **即时上报** - 测试重要事件即时发送
10. **手动刷新** - 测试手动触发队列刷新

#### 场景测试
11. **用户完整旅程** - 模拟真实用户行为链路
    - 访问首页 → 了解功能 → 观看视频 → 查看价格 → 注册 → 订阅

#### 性能测试
12. **性能测试** - 测试大量事件处理能力
    - 生成 100 个事件
    - 统计处理时间
    - 评估平均耗时

#### 边界测试
13. **错误处理** - 测试异常情况
    - 空数据处理
    - 超长字符串
    - 特殊字符和 emoji
    - 嵌套对象

**运行**:
```bash
yarn example:test
```

**输出示例**:
```
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║         🧪 埋点 SDK 综合测试程序                          ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝

============================================================
🧪 测试 1: SDK 初始化
============================================================
✅ SDK 初始化成功
ℹ️  配置: {...}

... (详细测试输出)

╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║         ✅ 所有测试完成                                    ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
```

## 📊 测试结果分析

### 成功标志
- ✅ 所有测试步骤显示成功标记
- ✅ 没有错误输出
- ✅ 批量上报正常触发
- ✅ 事件数据正确追踪

### 常见输出说明

#### 调试日志
当 `debug: true` 时，会看到详细的 SDK 日志：
```
[TrackingSDK] 事件已追踪: {...}
[TrackingSDK] 成功上报 5 个事件
```

#### 批量上报提示
当事件数量达到批量阈值时：
```
ℹ️  已生成 5 个事件 (应触发批量上报)
```

#### 性能统计
性能测试会输出详细统计：
```
ℹ️  总事件数: 100
ℹ️  总耗时: 250ms
ℹ️  平均每个事件: 2.50ms
```

## 🔧 自定义测试

### 修改测试配置

编辑测试文件中的配置：

```typescript
const TEST_CONFIG = {
  apiEndpoint: 'https://your-api.com',  // 修改为你的 API
  siteDomain: 'your-site.com',          // 修改为你的域名
  debug: true,                          // 调试模式
  batchSize: 5,                         // 批量阈值
  batchInterval: 3000,                  // 上报间隔
}
```

### 添加自定义测试

在测试程序中添加你的测试场景：

```typescript
async function testMyFeature(tracker: TrackingSDK): Promise<void> {
  printTestTitle('测试 XX: 我的功能')
  
  try {
    // 你的测试代码
    tracker.trackCustom('my_event', { data: 'test' })
    
    printSuccess('测试完成')
  } catch (error) {
    printError('测试失败', error)
  }
}
```

## 🐛 故障排查

### 问题 1: 找不到模块
**错误**: `Cannot find module '../src'`

**解决**: 
```bash
yarn build  # 先构建 SDK
```

### 问题 2: 没有调试日志
**原因**: `debug: false`

**解决**: 修改配置中的 `debug: true`

### 问题 3: 事件没有立即发送
**原因**: 批量上报机制

**说明**: 这是正常行为。事件会在以下情况发送：
- 达到批量阈值 (`batchSize`)
- 达到时间间隔 (`batchInterval`)
- 手动调用 `flush()`
- 页面关闭时

### 问题 4: API 请求失败
**错误**: `HTTP 404` 或 `Connection refused`

**说明**: 测试程序使用的是模拟 API 端点，实际请求可能会失败。这不影响测试 SDK 的功能逻辑。

**解决**: 如需真实 API 测试，请修改 `apiEndpoint` 为你的服务器地址。

## 📈 性能基准

### 预期性能指标

基于综合测试程序的性能测试：

| 指标 | 预期值 |
|------|--------|
| 单个事件处理时间 | < 5ms |
| 100 个事件处理时间 | < 500ms |
| 内存占用增长 | < 10MB |
| 批量上报延迟 | < 100ms |

### 性能优化建议

1. **批量大小**: 根据业务需求调整 `batchSize`
   - 高频事件: 增大批量 (10-20)
   - 低频事件: 减小批量 (3-5)

2. **上报间隔**: 根据实时性需求调整 `batchInterval`
   - 实时性要求高: 减小间隔 (1000-2000ms)
   - 实时性要求低: 增大间隔 (5000-10000ms)

3. **重要事件**: 使用 `sendImmediately()` 立即发送
   - 支付完成
   - 错误事件
   - 关键业务事件

## 📚 相关文档

- [示例程序总览](README.md)
- [主文档](../README.md)
- [API 文档](../README.md#-api-文档)

## 💡 最佳实践

### 开发阶段
```bash
# 1. 开启调试模式
debug: true

# 2. 使用快速测试验证功能
yarn example:quick

# 3. 检查控制台输出
```

### 测试阶段
```bash
# 1. 运行综合测试
yarn example:test

# 2. 检查所有场景
# 3. 验证性能指标
# 4. 测试边界情况
```

### 生产部署前
```bash
# 1. 关闭调试模式
debug: false

# 2. 优化批量参数
batchSize: 10
batchInterval: 5000

# 3. 启用本地存储
enableStorage: true

# 4. 最终测试
yarn example:test
```

## 🤝 贡献

欢迎提交新的测试场景和改进建议！

1. Fork 本项目
2. 创建测试分支
3. 添加/修改测试代码
4. 提交 Pull Request

## 📝 更新日志

### v1.0.0 (2024-11-28)
- ✅ 创建快速测试程序
- ✅ 创建综合测试程序
- ✅ 添加测试文档
- ✅ 添加 yarn 脚本命令

