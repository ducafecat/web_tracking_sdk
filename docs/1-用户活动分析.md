## ç”¨æˆ·æ´»åŠ¨åˆ†æ - æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆä¸‰ï¼šæ··åˆæ¶æ„ï¼‰

> **âš ï¸ é‡è¦è¯´æ˜**ï¼šæœ¬æ–‡æ¡£é‡‡ç”¨æ–¹æ¡ˆä¸‰ï¼ˆæ··åˆæ¶æ„ï¼‰è®¾è®¡ï¼Œä¸“é—¨é’ˆå¯¹**ç™¾ä¸‡çº§ç”¨æˆ·åœºæ™¯**ä¼˜åŒ–ã€‚
>
> - âœ… çªç ´ MongoDB å•æ–‡æ¡£ 16MB é™åˆ¶
> - âœ… æ”¯æŒé«˜æ•ˆåˆ†é¡µæŸ¥è¯¢
> - âœ… æ€§èƒ½ç¨³å®šï¼Œå¯æ‰©å±•è‡³åƒä¸‡çº§ç”¨æˆ·

### ğŸ“‹ ä¸€ã€éœ€æ±‚åˆ†æ

æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œéœ€è¦å®ç°ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **ç”¨æˆ·è¡Œä¸ºè¿½è¸ª**ï¼šæ³¨å†Œã€è®¢é˜…ã€ç™»å½•ç­‰å…³é”®è¡Œä¸º
2. **ç•™å­˜åˆ†æ**ï¼šæ–°å¢ã€æ´»è·ƒã€ç•™å­˜ã€æµå¤±ã€å›æµç­‰ç”¨æˆ·çŠ¶æ€
3. **å¤šç»´åº¦ç»Ÿè®¡**ï¼šå›½å®¶åˆ†å¸ƒã€è®¾å¤‡ç±»å‹ã€æ¥æºç»Ÿè®¡
4. **è§„æ¨¡è¦æ±‚**ï¼šæ”¯æŒç™¾ä¸‡çº§ç”¨æˆ·ï¼Œé«˜æ€§èƒ½æŸ¥è¯¢

### ğŸ—ï¸ äºŒã€æ•´ä½“æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®é‡‡é›†å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. æµè§ˆå™¨åŸ‹ç‚¹ (Ajax è¯·æ±‚)                                   â”‚
â”‚     - ç”¨æˆ·æ³¨å†Œäº‹ä»¶: /api/track/register                      â”‚
â”‚     - ç”¨æˆ·è®¢é˜…äº‹ä»¶: /api/track/subscribe                     â”‚
â”‚     - ç”¨æˆ·ç™»å½•äº‹ä»¶: /api/track/login                         â”‚
â”‚  2. Web æœåŠ¡å™¨æ—¥å¿— (access.log)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å¤„ç†å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. æ—¥å¿—åŒæ­¥ (1_logs_sync.ts)                                â”‚
â”‚     - è¯†åˆ«ç”¨æˆ·è¡Œä¸ºäº‹ä»¶                                       â”‚
â”‚     - ä¿å­˜åˆ° user_events é›†åˆ                                â”‚
â”‚  2. ç”¨æˆ·æ´»åŠ¨åˆ†æ (13_user_activity_analysis.ts)              â”‚
â”‚     - è®¡ç®—å„é¡¹æŒ‡æ ‡                                           â”‚
â”‚     - ç”Ÿæˆæ—¥æŠ¥è¡¨å’Œæ˜ç»†è¡¨                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å­˜å‚¨å±‚ (MongoDB)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. user_events - ç”¨æˆ·äº‹ä»¶è¡¨ (åŸå§‹æ•°æ®)                      â”‚
â”‚  2. user_activity_daily - ç”¨æˆ·æ´»åŠ¨æ—¥æŠ¥è¡¨ (èšåˆæŒ‡æ ‡)          â”‚
â”‚  3. user_activity_detail - ç”¨æˆ·æ´»åŠ¨æ˜ç»†è¡¨ (ç”¨æˆ·åˆ—è¡¨)         â”‚
â”‚  4. user_activity_summary - ç”¨æˆ·æ´»åŠ¨æ±‡æ€»è¡¨ (ç”¨æˆ·ç”»åƒ)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ æ–¹æ¡ˆä¸‰ï¼šæ··åˆæ¶æ„ä¼˜åŠ¿**ï¼ˆé€‚åˆç™¾ä¸‡çº§ç”¨æˆ·åœºæ™¯ï¼‰

- **æ—¥æŠ¥è¡¨**ï¼šåªå­˜å‚¨ç»Ÿè®¡æ•°å­—å’ŒèšåˆæŒ‡æ ‡ï¼Œå•æ–‡æ¡£å¤§å°å¯æ§
- **æ˜ç»†è¡¨**ï¼šç‹¬ç«‹å­˜å‚¨ç”¨æˆ·æ´»åŠ¨æ ‡è®°ï¼Œæ”¯æŒåˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…å•æ–‡æ¡£è¿‡å¤§
- **æ±‡æ€»è¡¨**ï¼šä¿å­˜ç”¨æˆ·ç”»åƒä¿¡æ¯ï¼Œå¿«é€Ÿè®¡ç®—ç•™å­˜ã€æµå¤±ç­‰æŒ‡æ ‡
- **äº‹ä»¶è¡¨**ï¼šä¿ç•™åŸå§‹æ•°æ®ï¼Œæ”¯æŒé‡æ–°è®¡ç®—å’Œæ•°æ®å›æº¯

### ğŸ—„ï¸ ä¸‰ã€æ•°æ®åº“è®¾è®¡

#### ğŸ’¡ æ•°æ®æ¨¡å‹å¯¹æ¯”ï¼ˆä¸ºä»€ä¹ˆé€‰æ‹©æ–¹æ¡ˆä¸‰ï¼‰

| å¯¹æ¯”é¡¹          | åŸæ–¹æ¡ˆï¼ˆæ•°ç»„å­˜å‚¨ï¼‰   | æ–¹æ¡ˆä¸‰ï¼ˆæ··åˆæ¶æ„ï¼‰ |
| --------------- | -------------------- | ------------------ |
| **å•æ–‡æ¡£å¤§å°**  | 100ä¸‡ç”¨æˆ· â‰ˆ 137MB âŒ | < 100KB âœ…         |
| **MongoDBé™åˆ¶** | è¶…è¿‡16MBé™åˆ¶ âŒ      | ç¬¦åˆé™åˆ¶ âœ…        |
| **æŸ¥è¯¢æ€§èƒ½**    | éœ€åŠ è½½æ•´ä¸ªæ–‡æ¡£ âŒ    | æŒ‰éœ€æŸ¥è¯¢ âœ…        |
| **åˆ†é¡µæ”¯æŒ**    | å†…å­˜åˆ†é¡µï¼Œæ…¢ âŒ      | æ•°æ®åº“åˆ†é¡µï¼Œå¿« âœ…  |
| **ç´¢å¼•æ•ˆç‡**    | æ•°ç»„ç´¢å¼•æ•ˆç‡ä½ âŒ    | å¤šç»´ç´¢å¼•é«˜æ•ˆ âœ…    |
| **æ‰©å±•æ€§**      | æ— æ³•æ‰©å±• âŒ          | æ”¯æŒåƒä¸‡çº§ âœ…      |
| **å­˜å‚¨æˆæœ¬**    | é‡å¤æ•°æ®å¤š âŒ        | è§„èŒƒåŒ–å­˜å‚¨ âœ…      |

**æ–¹æ¡ˆä¸‰æ¶æ„è¯´æ˜**ï¼š

```
ğŸ“Š user_activity_daily (æ—¥æŠ¥è¡¨)
   â†“ å­˜å‚¨: èšåˆæŒ‡æ ‡ã€ç»Ÿè®¡æ•°å­—ã€åˆ†å¸ƒæ•°æ®
   â†“ å¤§å°: < 100KB/å¤©
   â†“ ç”¨é€”: è¶‹åŠ¿åˆ†æã€å›¾è¡¨å±•ç¤ºã€API å¿«é€Ÿå“åº”

ğŸ“ user_activity_detail (æ˜ç»†è¡¨)
   â†“ å­˜å‚¨: ç”¨æˆ·åˆ—è¡¨ã€æ´»åŠ¨ç±»å‹ã€æ ‡ç­¾ä¿¡æ¯
   â†“ å¤§å°: çº¦ 100 å­—èŠ‚/ç”¨æˆ·
   â†“ ç”¨é€”: ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ã€åˆ†é¡µå±•ç¤ºã€å¤šç»´ç­›é€‰

ğŸ‘¤ user_activity_summary (æ±‡æ€»è¡¨)
   â†“ å­˜å‚¨: ç”¨æˆ·ç”»åƒã€ç´¯è®¡æ•°æ®ã€çŠ¶æ€ä¿¡æ¯
   â†“ å¤§å°: çº¦ 200 å­—èŠ‚/ç”¨æˆ·
   â†“ ç”¨é€”: ç”¨æˆ·è¯¦æƒ…ã€å®æ—¶è®¡ç®—ã€å¿«é€ŸæŸ¥è¯¢

ğŸ”„ user_events (äº‹ä»¶è¡¨)
   â†“ å­˜å‚¨: åŸå§‹äº‹ä»¶æ•°æ®
   â†“ å¤§å°: æµ·é‡
   â†“ ç”¨é€”: æ•°æ®å›æº¯ã€é‡æ–°è®¡ç®—ã€å®¡è®¡è¿½è¸ª
```

#### 3.1 ç”¨æˆ·äº‹ä»¶è¡¨ (user_events)

å­˜å‚¨æ‰€æœ‰ç”¨æˆ·è¡Œä¸ºäº‹ä»¶çš„åŸå§‹æ•°æ®ï¼š

```typescript
// src/types/mongo.ts ä¸­æ–°å¢

/**
 * ç”¨æˆ·äº‹ä»¶è¡¨
 * ç”¨äºå­˜å‚¨ç”¨æˆ·çš„å…³é”®è¡Œä¸ºäº‹ä»¶ï¼ˆæ³¨å†Œã€è®¢é˜…ã€ç™»å½•ç­‰ï¼‰
 */
export interface UserEventMongo extends Document {
  /** MongoDB æ–‡æ¡£ ID */
  readonly _id: ObjectId;

  /** äº‹ä»¶æ—¶é—´æˆ³ï¼ˆUnix æ—¶é—´æˆ³ï¼Œç²¾ç¡®åˆ°æ¯«ç§’ï¼‰ */
  readonly timestamp: number;

  /** æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰ */
  readonly date: string;

  /** äº‹ä»¶ç±»å‹ */
  readonly eventType: 'register' | 'subscribe' | 'login' | 'logout' | 'visit';

  /** ç”¨æˆ· UIDï¼ˆä¸šåŠ¡ç³»ç»Ÿçš„ç”¨æˆ· IDï¼‰ */
  readonly x_uid: string;

  /** é“¾æ¥ IDï¼ˆå¯é€‰ï¼Œç”¨äºå…³è”å…·ä½“ä¸šåŠ¡ï¼‰ */
  readonly x_link_id?: string;

  /** å®¢æˆ·ç«¯ IP åœ°å€ */
  readonly clientIp: string;

  /** ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ˆåŸºäº IP + User-Agent ç”Ÿæˆï¼‰ */
  readonly userId: string;

  /** ä¼šè¯ ID */
  readonly sessionId: string;

  /** è¯·æ±‚ URI */
  readonly uri: string;

  /** è¯·æ±‚æ¥æºï¼ˆRefererï¼‰ */
  readonly referer?: string;

  /** æ¥æºåŸŸå */
  readonly refererDomain?: string;

  /** æ¥æºç±»å‹ */
  readonly refererType?: 'direct' | 'search' | 'social' | 'internal' | 'external';

  /** åŸå§‹ User-Agent å­—ç¬¦ä¸² */
  readonly userAgent: string;

  /** è§£æåçš„ç”¨æˆ·ä»£ç†ä¿¡æ¯ */
  readonly userAgentInfo: UserAgentInfo;

  /** åœ°ç†ä½ç½®ä¿¡æ¯ */
  readonly geolocation?: GeolocationInfo;

  /** äº‹ä»¶é™„åŠ æ•°æ®ï¼ˆJSON æ ¼å¼ï¼Œå­˜å‚¨ç‰¹å®šäº‹ä»¶çš„é¢å¤–ä¿¡æ¯ï¼‰ */
  readonly eventData?: {
    /** è®¢é˜…è®¡åˆ’ï¼ˆå¦‚æœæ˜¯è®¢é˜…äº‹ä»¶ï¼‰ */
    readonly plan?: string;
    /** è®¢é˜…æ—¶é•¿ï¼ˆæœˆï¼‰ */
    readonly duration?: number;
    /** å…¶ä»–ä¸šåŠ¡æ•°æ® */
    readonly [key: string]: any;
  };

  /** åˆ›å»ºæ—¶é—´ */
  readonly createdAt: Date;

  /** æ›´æ–°æ—¶é—´ */
  readonly updatedAt: Date;
}
```

**ç´¢å¼•è®¾è®¡**ï¼š

```typescript
// å¤åˆç´¢å¼•ï¼šæ—¥æœŸ + ç”¨æˆ· UID + äº‹ä»¶ç±»å‹
{ date: 1, x_uid: 1, eventType: 1 }

// å•å­—æ®µç´¢å¼•
{ timestamp: 1 }
{ x_uid: 1 }
{ eventType: 1 }
{ date: 1 }
```

#### 3.2 ç”¨æˆ·æ´»åŠ¨æ—¥æŠ¥è¡¨ (user_activity_daily)

å­˜å‚¨æ¯æ—¥ç”¨æˆ·æ´»åŠ¨åˆ†æçš„èšåˆæŒ‡æ ‡ï¼ˆä¸åŒ…å«ç”¨æˆ·åˆ—è¡¨ï¼Œç¡®ä¿æ–‡æ¡£å¤§å°å¯æ§ï¼‰ï¼š

```typescript
/**
 * ç”¨æˆ·æ´»åŠ¨æ—¥æŠ¥è¡¨
 * ç”¨äºå­˜å‚¨æ¯æ—¥çš„ç”¨æˆ·æ´»åŠ¨åˆ†ææ•°æ®ï¼ˆä»…åŒ…å«èšåˆæŒ‡æ ‡ï¼‰
 * æ³¨æ„ï¼šä¸ºäº†æ”¯æŒç™¾ä¸‡çº§ç”¨æˆ·åœºæ™¯ï¼Œç”¨æˆ·åˆ—è¡¨å·²ç§»è‡³ user_activity_detail è¡¨
 */
export interface UserActivityDailyMongo extends Document {
  /** MongoDB æ–‡æ¡£ ID */
  readonly _id: ObjectId;

  /** ç»Ÿè®¡æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰ */
  readonly date: string;

  // ========== æ ¸å¿ƒæŒ‡æ ‡ ==========

  /** æ–°å¢æ³¨å†Œç”¨æˆ·æ•° */
  readonly newRegisters: number;

  /** æ–°å¢è®¢é˜…ç”¨æˆ·æ•° */
  readonly newSubscribers: number;

  /** æ´»è·ƒç”¨æˆ·æ•°ï¼ˆå½“æ—¥ç™»å½•æˆ–è®¿é—®çš„ç”¨æˆ·æ•°ï¼‰ */
  readonly activeUsers: number;

  /** ç•™å­˜ç”¨æˆ·æ•°ï¼ˆæ˜¨æ—¥æ–°æ³¨å†Œï¼Œä»Šæ—¥ç™»å½•çš„ç”¨æˆ·æ•°ï¼‰ */
  readonly retainedUsers: number;

  /** ç•™å­˜ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ */
  readonly retentionRate: number;

  /** æµå¤±ç”¨æˆ·æ•°ï¼ˆè¿‡å» 30 å¤©æœªç™»å½•çš„ç”¨æˆ·æ•°ï¼‰ */
  readonly churnedUsers: number;

  /** æµå¤±ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ */
  readonly churnRate: number;

  /** å›æµç”¨æˆ·æ•°ï¼ˆä»Šæ—¥ç™»å½•ï¼Œä½†è¿‡å» 30 å¤©æœªç™»å½•çš„ç”¨æˆ·æ•°ï¼‰ */
  readonly returnedUsers: number;

  /** å›æµç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ */
  readonly returnRate: number;

  /** ç´¯è®¡æ³¨å†Œç”¨æˆ·æ•°ï¼ˆæˆªæ­¢åˆ°å½“å¤©çš„æ€»æ³¨å†Œç”¨æˆ·æ•°ï¼‰ */
  readonly totalRegisters: number;

  /** ç´¯è®¡è®¢é˜…ç”¨æˆ·æ•°ï¼ˆæˆªæ­¢åˆ°å½“å¤©çš„æ€»è®¢é˜…ç”¨æˆ·æ•°ï¼‰ */
  readonly totalSubscribers: number;

  // ========== å›½å®¶åˆ†å¸ƒç»Ÿè®¡ ==========

  /** æ³¨å†Œç”¨æˆ·å›½å®¶åˆ†å¸ƒ */
  readonly registerCountryStats: {
    readonly [countryCode: string]: {
      readonly count: number;
      readonly percentage: number;
    };
  };

  /** è®¢é˜…ç”¨æˆ·å›½å®¶åˆ†å¸ƒ */
  readonly subscriberCountryStats: {
    readonly [countryCode: string]: {
      readonly count: number;
      readonly percentage: number;
    };
  };

  // ========== è®¾å¤‡ç±»å‹ç»Ÿè®¡ ==========

  /** æ³¨å†Œç”¨æˆ·è®¾å¤‡ç±»å‹åˆ†å¸ƒ */
  readonly registerDeviceStats: {
    readonly [deviceType: string]: {
      readonly count: number;
      readonly percentage: number;
    };
  };

  /** è®¢é˜…ç”¨æˆ·è®¾å¤‡ç±»å‹åˆ†å¸ƒ */
  readonly subscriberDeviceStats: {
    readonly [deviceType: string]: {
      readonly count: number;
      readonly percentage: number;
    };
  };

  // ========== æ¥æºç»Ÿè®¡ ==========

  /** æ¥æºåŸŸåç»Ÿè®¡ */
  readonly refererDomainStats: {
    readonly [domain: string]: {
      /** æ¥æºç”¨æˆ·æ•° */
      readonly userCount: number;
      /** æ³¨å†Œè½¬åŒ–ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ */
      readonly registerConversionRate: number;
      /** è®¢é˜…è½¬åŒ–ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ */
      readonly subscribeConversionRate: number;
    };
  };

  /** æ¥æº URL ç»Ÿè®¡ï¼ˆTop 100ï¼‰ */
  readonly refererUrlStats: readonly {
    readonly url: string;
    readonly userCount: number;
    readonly registerCount: number;
    readonly subscribeCount: number;
  }[];

  /** æ¥æºç±»å‹ç»Ÿè®¡ */
  readonly refererTypeStats: {
    readonly direct: number;
    readonly search: number;
    readonly social: number;
    readonly internal: number;
    readonly external: number;
  };

  /** åˆ›å»ºæ—¶é—´ */
  readonly createdAt: Date;

  /** æ›´æ–°æ—¶é—´ */
  readonly updatedAt: Date;
}
```

**ç´¢å¼•è®¾è®¡**ï¼š

```typescript
// å”¯ä¸€ç´¢å¼•
{
  date: 1;
} // unique

// æ—¶é—´èŒƒå›´æŸ¥è¯¢
{
  date: -1;
}
```

#### 3.3 ç”¨æˆ·æ´»åŠ¨æ˜ç»†è¡¨ (user_activity_detail)

å­˜å‚¨æ¯æ—¥ç”¨æˆ·æ´»åŠ¨çš„è¯¦ç»†åˆ—è¡¨ï¼Œæ”¯æŒæŒ‰éœ€åˆ†é¡µæŸ¥è¯¢ï¼š

```typescript
/**
 * ç”¨æˆ·æ´»åŠ¨æ˜ç»†è¡¨
 * ç”¨äºå­˜å‚¨æ¯æ—¥ç”¨æˆ·æ´»åŠ¨çš„è¯¦ç»†åˆ—è¡¨ï¼Œæ”¯æŒæŒ‰éœ€æŸ¥è¯¢å’Œåˆ†é¡µ
 * è§£å†³ç™¾ä¸‡çº§ç”¨æˆ·åœºæ™¯ä¸‹ï¼Œæ—¥æŠ¥è¡¨æ–‡æ¡£è¿‡å¤§çš„é—®é¢˜
 */
export interface UserActivityDetailMongo extends Document {
  /** MongoDB æ–‡æ¡£ ID */
  readonly _id: ObjectId;

  /** ç»Ÿè®¡æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰ */
  readonly date: string;

  /** ç”¨æˆ· UID */
  readonly x_uid: string;

  /** ç”¨æˆ·æ´»åŠ¨ç±»å‹ï¼ˆå¯ä»¥æ˜¯å¤šç§ç±»å‹çš„ç»„åˆï¼‰ */
  readonly activityTypes: readonly (
    | 'new_register'
    | 'new_subscriber'
    | 'active'
    | 'retained'
    | 'churned'
    | 'returned'
  )[];

  /** å›½å®¶ä»£ç  */
  readonly countryCode?: string;

  /** è®¾å¤‡ç±»å‹ */
  readonly deviceType?: string;

  /** æ¥æºåŸŸå */
  readonly refererDomain?: string;

  /** æ¥æºç±»å‹ */
  readonly refererType?: 'direct' | 'search' | 'social' | 'internal' | 'external';

  /** åˆ›å»ºæ—¶é—´ */
  readonly createdAt: Date;
}
```

**ç´¢å¼•è®¾è®¡**ï¼š

```typescript
// å¤åˆç´¢å¼• - æŒ‰æ—¥æœŸå’Œæ´»åŠ¨ç±»å‹æŸ¥è¯¢
{ date: 1, activityTypes: 1 }

// å¤åˆç´¢å¼• - æŒ‰æ—¥æœŸå’Œç”¨æˆ·æŸ¥è¯¢
{ date: 1, x_uid: 1 }

// å¤åˆç´¢å¼• - æŒ‰æ—¥æœŸã€æ´»åŠ¨ç±»å‹å’Œå›½å®¶æŸ¥è¯¢
{ date: 1, activityTypes: 1, countryCode: 1 }

// å•å­—æ®µç´¢å¼• - æŒ‰ç”¨æˆ·æŸ¥è¯¢
{ x_uid: 1 }
```

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š

```javascript
// æŸ¥è¯¢æŸå¤©çš„æ–°æ³¨å†Œç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
db.user_activity_detail
  .find({ date: '2025-11-27', activityTypes: 'new_register' }, { x_uid: 1, countryCode: 1 })
  .skip(0)
  .limit(100);

// ç»Ÿè®¡æŸå¤©æ–°æ³¨å†Œç”¨æˆ·æ•°
db.user_activity_detail.countDocuments({
  date: '2025-11-27',
  activityTypes: 'new_register',
});

// æŸ¥è¯¢æŸå¤©æµå¤±ç”¨æˆ·ä¸­æ¥è‡ªç¾å›½çš„ç”¨æˆ·
db.user_activity_detail.find({
  date: '2025-11-27',
  activityTypes: 'churned',
  countryCode: 'US',
});

// æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ´»åŠ¨å†å²
db.user_activity_detail.find({ x_uid: 'user_123' }).sort({ date: -1 }).limit(30);
```

#### 3.4 ç”¨æˆ·æ´»åŠ¨æ±‡æ€»è¡¨ (user_activity_summary)

å­˜å‚¨æ¯ä¸ªç”¨æˆ·çš„æ´»åŠ¨æ±‡æ€»ä¿¡æ¯ï¼ˆç”¨äºå¿«é€Ÿè®¡ç®—ç•™å­˜ã€æµå¤±ç­‰æŒ‡æ ‡ï¼‰ï¼š

```typescript
/**
 * ç”¨æˆ·æ´»åŠ¨æ±‡æ€»è¡¨
 * ç”¨äºå­˜å‚¨æ¯ä¸ªç”¨æˆ·çš„æ´»åŠ¨æ±‡æ€»ä¿¡æ¯ï¼Œä¾¿äºå¿«é€Ÿè®¡ç®—ç•™å­˜ã€æµå¤±ç­‰æŒ‡æ ‡
 */
export interface UserActivitySummaryMongo extends Document {
  /** MongoDB æ–‡æ¡£ ID */
  readonly _id: ObjectId;

  /** ç”¨æˆ· UID */
  readonly x_uid: string;

  /** æ³¨å†Œæ—¥æœŸ */
  readonly registerDate: string;

  /** é¦–æ¬¡è®¢é˜…æ—¥æœŸï¼ˆå¦‚æœå·²è®¢é˜…ï¼‰ */
  readonly firstSubscribeDate?: string;

  /** é¦–æ¬¡è®¿é—®æ—¶é—´ */
  readonly firstVisitAt: Date;

  /** æœ€åè®¿é—®æ—¶é—´ */
  readonly lastVisitAt: Date;

  /** æœ€åç™»å½•æ—¥æœŸ */
  readonly lastLoginDate: string;

  /** ç´¯è®¡ç™»å½•å¤©æ•° */
  readonly totalLoginDays: number;

  /** ç´¯è®¡è®¿é—®æ¬¡æ•° */
  readonly totalVisits: number;

  /** æ˜¯å¦ä¸ºè®¢é˜…ç”¨æˆ· */
  readonly isSubscriber: boolean;

  /** ç”¨æˆ·çŠ¶æ€ */
  readonly status: 'active' | 'churned' | 'new';

  /** æ³¨å†Œæ—¶çš„å›½å®¶ä»£ç  */
  readonly registerCountry?: string;

  /** æ³¨å†Œæ—¶çš„è®¾å¤‡ç±»å‹ */
  readonly registerDevice?: string;

  /** æ³¨å†Œæ¥æºåŸŸå */
  readonly registerRefererDomain?: string;

  /** æ³¨å†Œæ¥æº URL */
  readonly registerRefererUrl?: string;

  /** åˆ›å»ºæ—¶é—´ */
  readonly createdAt: Date;

  /** æ›´æ–°æ—¶é—´ */
  readonly updatedAt: Date;
}
```

**ç´¢å¼•è®¾è®¡**ï¼š

```typescript
// å”¯ä¸€ç´¢å¼•
{ x_uid: 1 } // unique

// æŸ¥è¯¢ç´¢å¼•
{ registerDate: 1 }
{ lastLoginDate: 1 }
{ status: 1 }
{ isSubscriber: 1 }

// å¤åˆç´¢å¼• - æŒ‰çŠ¶æ€å’Œæœ€åç™»å½•æ—¥æœŸæŸ¥è¯¢
{ status: 1, lastLoginDate: 1 }
```

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š

```javascript
// æŸ¥è¯¢æŸå¤©æ³¨å†Œçš„æ‰€æœ‰ç”¨æˆ·
db.user_activity_summary.find({ registerDate: '2025-11-27' });

// æŸ¥è¯¢æµå¤±ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
db.user_activity_summary.find({ status: 'churned' }).sort({ lastLoginDate: 1 }).skip(0).limit(100);

// æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ±‡æ€»ä¿¡æ¯
db.user_activity_summary.findOne({ x_uid: 'user_123' });
```

### ğŸ”§ å››ã€æ ¸å¿ƒå®ç°ä»£ç 

#### 4.1 æ—¥å¿—åŒæ­¥å¢å¼º (ä¿®æ”¹ 1_logs_sync.ts)

åœ¨ç°æœ‰çš„æ—¥å¿—åŒæ­¥é€»è¾‘ä¸­ï¼Œå¢åŠ äº‹ä»¶è¯†åˆ«å’Œä¿å­˜ï¼š

```typescript
// src/logic/1_logs_sync.ts ä¸­å¢åŠ çš„æ–¹æ³•

/**
 * è¯†åˆ«å¹¶ä¿å­˜ç”¨æˆ·äº‹ä»¶
 * æ ¹æ® URI åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·è¡Œä¸ºäº‹ä»¶ï¼ˆæ³¨å†Œã€è®¢é˜…ã€ç™»å½•ç­‰ï¼‰
 */
private async detectAndSaveUserEvent(logData: LogsMongo): Promise<void> {
  if (!this.mongoDb) return;

  const uri = logData.uri.toLowerCase();
  let eventType: 'register' | 'subscribe' | 'login' | null = null;

  // æ ¹æ® URI è·¯å¾„è¯†åˆ«äº‹ä»¶ç±»å‹
  // éœ€è¦æ ¹æ®å®é™…ä¸šåŠ¡è°ƒæ•´åŒ¹é…è§„åˆ™
  if (uri.includes('/api/track/register') || uri.includes('/register')) {
    eventType = 'register';
  } else if (uri.includes('/api/track/subscribe') || uri.includes('/subscribe')) {
    eventType = 'subscribe';
  } else if (uri.includes('/api/track/login') || uri.includes('/login')) {
    eventType = 'login';
  }

  // å¦‚æœè¯†åˆ«åˆ°ç”¨æˆ·äº‹ä»¶ï¼Œä¿å­˜åˆ° user_events é›†åˆ
  if (eventType && logData.x_uid) {
    const collection = this.mongoDb.collection<UserEventMongo>('user_events');

    // æå–æ¥æºåŸŸå
    let refererDomain: string | undefined;
    let refererType: 'direct' | 'search' | 'social' | 'internal' | 'external' | undefined;

    if (logData.referer && logData.referer !== '-') {
      try {
        const refererUrl = new URL(logData.referer);
        refererDomain = refererUrl.hostname;
        refererType = this.analyzeRefererType(logData.referer);
      } catch (error) {
        // å¿½ç•¥æ— æ•ˆ URL
      }
    }

    const userEvent: Omit<UserEventMongo, '_id'> = {
      timestamp: logData.timestamp,
      date: logData.date,
      eventType,
      x_uid: logData.x_uid,
      x_link_id: logData.x_link_id,
      clientIp: logData.clientIp,
      userId: logData.userId,
      sessionId: logData.sessionId,
      uri: logData.uri,
      referer: logData.referer,
      refererDomain,
      refererType,
      userAgent: logData.userAgent,
      userAgentInfo: logData.userAgentInfo,
      geolocation: logData.geolocation,
      eventData: {}, // å¯ä»¥ä» URI å‚æ•°ä¸­æå–é¢å¤–æ•°æ®
      createdAt: new Date(),
      updatedAt: new Date(),
    };

    try {
      await collection.insertOne(userEvent as any);
      logger.debug(`ç”¨æˆ·äº‹ä»¶å·²ä¿å­˜: ${eventType} for user ${logData.x_uid}`);
    } catch (error) {
      logger.error('ä¿å­˜ç”¨æˆ·äº‹ä»¶å¤±è´¥:', error);
    }
  }
}

/**
 * åˆ†ææ¥æºç±»å‹
 */
private analyzeRefererType(referer: string): 'direct' | 'search' | 'social' | 'internal' | 'external' {
  if (!referer || referer === '-') return 'direct';

  try {
    const refererUrl = new URL(referer);
    const domain = refererUrl.hostname.toLowerCase();

    // æœç´¢å¼•æ“
    if (
      domain.includes('google') ||
      domain.includes('baidu') ||
      domain.includes('bing') ||
      domain.includes('yahoo')
    ) {
      return 'search';
    }

    // ç¤¾äº¤åª’ä½“
    if (
      domain.includes('facebook') ||
      domain.includes('twitter') ||
      domain.includes('instagram') ||
      domain.includes('linkedin')
    ) {
      return 'social';
    }

    return 'external';
  } catch {
    return 'direct';
  }
}
```

#### 4.2 ç”¨æˆ·æ´»åŠ¨åˆ†æä¸»é€»è¾‘ (æ–°å»º 13_user_activity_analysis.ts)

```typescript
// src/logic/13_user_activity_analysis.ts

import { MongoClient, Db } from 'mongodb';
import { config } from '../config';
import { logger } from '../utils/logger';
import { runWithLock } from '../utils/task-lock';
import {
  UserEventMongo,
  UserActivityDailyMongo,
  UserActivityDetailMongo, // æ–°å¢ï¼šç”¨æˆ·æ´»åŠ¨æ˜ç»†è¡¨
  UserActivitySummaryMongo,
} from '../types/mongo';
import { getCurrentDate, getPreviousDate, getDateDaysAgo } from '../utils/date-utils';

/**
 * ç”¨æˆ·æ´»åŠ¨åˆ†æå¤„ç†å™¨ç±»
 * è´Ÿè´£åˆ†æç”¨æˆ·ç•™å­˜ã€æµå¤±ã€å›æµç­‰å…³é”®æŒ‡æ ‡
 */
class UserActivityAnalysisProcessor {
  private mongoDb: Db | null = null;
  private mongoClient: MongoClient | null = null;

  /**
   * è¿æ¥åˆ°MongoDBæ•°æ®åº“
   */
  private async connectToMongoDB(): Promise<void> {
    if (this.mongoDb) return;

    this.mongoClient = new MongoClient(config.mongo.weblogs as string);
    await this.mongoClient.connect();

    const dbUrl = new URL(config.mongo.weblogs as string);
    const dbName = dbUrl.pathname.substring(1) || 'weblogs';
    this.mongoDb = this.mongoClient.db(dbName);

    await this.createIndexes();
    logger.info('MongoDB è¿æ¥æˆåŠŸ');
  }

  /**
   * åˆ›å»ºMongoDBç´¢å¼•
   */
  private async createIndexes(): Promise<void> {
    if (!this.mongoDb) {
      throw new Error('MongoDB è¿æ¥æœªå»ºç«‹');
    }

    // user_events ç´¢å¼•
    const eventsCollection = this.mongoDb.collection<UserEventMongo>('user_events');
    await eventsCollection.createIndex({ date: 1, x_uid: 1, eventType: 1 }, { background: true });
    await eventsCollection.createIndex({ x_uid: 1 }, { background: true });
    await eventsCollection.createIndex({ eventType: 1 }, { background: true });
    await eventsCollection.createIndex({ timestamp: 1 }, { background: true });

    // user_activity_daily ç´¢å¼•
    const dailyCollection = this.mongoDb.collection<UserActivityDailyMongo>('user_activity_daily');
    await dailyCollection.createIndex({ date: 1 }, { unique: true, background: true });

    // user_activity_detail ç´¢å¼•ï¼ˆæ–°å¢ï¼‰
    const detailCollection =
      this.mongoDb.collection<UserActivityDetailMongo>('user_activity_detail');
    await detailCollection.createIndex({ date: 1, activityTypes: 1 }, { background: true });
    await detailCollection.createIndex({ date: 1, x_uid: 1 }, { background: true });
    await detailCollection.createIndex(
      { date: 1, activityTypes: 1, countryCode: 1 },
      { background: true },
    );
    await detailCollection.createIndex({ x_uid: 1 }, { background: true });

    // user_activity_summary ç´¢å¼•
    const summaryCollection =
      this.mongoDb.collection<UserActivitySummaryMongo>('user_activity_summary');
    await summaryCollection.createIndex({ x_uid: 1 }, { unique: true, background: true });
    await summaryCollection.createIndex({ registerDate: 1 }, { background: true });
    await summaryCollection.createIndex({ lastLoginDate: 1 }, { background: true });
    await summaryCollection.createIndex({ status: 1, lastLoginDate: 1 }, { background: true });

    logger.info('ç”¨æˆ·æ´»åŠ¨åˆ†æç´¢å¼•åˆ›å»ºæˆåŠŸ');
  }

  /**
   * å…³é—­æ•°æ®åº“è¿æ¥
   */
  private async closeConnections(): Promise<void> {
    if (this.mongoClient) {
      await this.mongoClient.close();
      this.mongoClient = null;
      this.mongoDb = null;
      logger.info('MongoDB è¿æ¥å·²å…³é—­');
    }
  }

  /**
   * æ›´æ–°ç”¨æˆ·æ´»åŠ¨æ±‡æ€»è¡¨
   * åŸºäºå½“å¤©çš„äº‹ä»¶æ›´æ–°æ¯ä¸ªç”¨æˆ·çš„æ±‡æ€»ä¿¡æ¯
   */
  private async updateUserSummary(targetDate: string): Promise<void> {
    if (!this.mongoDb) {
      throw new Error('MongoDB è¿æ¥æœªå»ºç«‹');
    }

    const eventsCollection = this.mongoDb.collection<UserEventMongo>('user_events');
    const summaryCollection =
      this.mongoDb.collection<UserActivitySummaryMongo>('user_activity_summary');

    // è·å–å½“å¤©çš„æ‰€æœ‰äº‹ä»¶
    const events = await eventsCollection.find({ date: targetDate }).toArray();

    for (const event of events) {
      // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·æ±‡æ€»è®°å½•
      const existingSummary = await summaryCollection.findOne({ x_uid: event.x_uid });

      if (!existingSummary) {
        // æ–°ç”¨æˆ·ï¼Œåˆ›å»ºæ±‡æ€»è®°å½•
        const newSummary: Omit<UserActivitySummaryMongo, '_id'> = {
          x_uid: event.x_uid,
          registerDate: event.eventType === 'register' ? event.date : targetDate,
          firstSubscribeDate: event.eventType === 'subscribe' ? event.date : undefined,
          firstVisitAt: new Date(event.timestamp),
          lastVisitAt: new Date(event.timestamp),
          lastLoginDate: event.date,
          totalLoginDays: 1,
          totalVisits: 1,
          isSubscriber: event.eventType === 'subscribe',
          status: 'new',
          registerCountry: event.geolocation?.countryCode,
          registerDevice: event.userAgentInfo?.deviceType,
          registerRefererDomain: event.refererDomain,
          registerRefererUrl: event.referer,
          createdAt: new Date(),
          updatedAt: new Date(),
        };

        await summaryCollection.insertOne(newSummary as any);
      } else {
        // æ›´æ–°ç°æœ‰ç”¨æˆ·æ±‡æ€»
        const updateData: any = {
          lastVisitAt: new Date(event.timestamp),
          lastLoginDate: event.date,
          totalVisits: existingSummary.totalVisits + 1,
          updatedAt: new Date(),
        };

        // å¦‚æœæ˜¯ç™»å½•äº‹ä»¶ä¸”æ—¥æœŸä¸åŒï¼Œå¢åŠ ç™»å½•å¤©æ•°
        if (event.eventType === 'login' && existingSummary.lastLoginDate !== event.date) {
          updateData.totalLoginDays = existingSummary.totalLoginDays + 1;
        }

        // å¦‚æœæ˜¯è®¢é˜…äº‹ä»¶
        if (event.eventType === 'subscribe') {
          updateData.isSubscriber = true;
          if (!existingSummary.firstSubscribeDate) {
            updateData.firstSubscribeDate = event.date;
          }
        }

        // æ›´æ–°ç”¨æˆ·çŠ¶æ€
        updateData.status = 'active';

        await summaryCollection.updateOne({ x_uid: event.x_uid }, { $set: updateData });
      }
    }

    logger.info(`ç”¨æˆ·æ±‡æ€»è¡¨æ›´æ–°å®Œæˆ: ${events.length} æ¡äº‹ä»¶`);
  }

  /**
   * è®¡ç®—å½“å¤©çš„ç”¨æˆ·æ´»åŠ¨æŒ‡æ ‡
   */
  private async calculateDailyMetrics(targetDate: string): Promise<UserActivityDailyMongo> {
    if (!this.mongoDb) {
      throw new Error('MongoDB è¿æ¥æœªå»ºç«‹');
    }

    const eventsCollection = this.mongoDb.collection<UserEventMongo>('user_events');
    const summaryCollection =
      this.mongoDb.collection<UserActivitySummaryMongo>('user_activity_summary');

    const yesterday = getPreviousDate(targetDate);
    const thirtyDaysAgo = getDateDaysAgo(targetDate, 30);

    // 1. æ–°å¢æ³¨å†Œç”¨æˆ·
    const newRegisterEvents = await eventsCollection
      .find({ date: targetDate, eventType: 'register' })
      .toArray();
    const newRegisterUsers = [...new Set(newRegisterEvents.map(e => e.x_uid))];

    // 2. æ–°å¢è®¢é˜…ç”¨æˆ·
    const newSubscribeEvents = await eventsCollection
      .find({ date: targetDate, eventType: 'subscribe' })
      .toArray();
    const newSubscriberUsers = [...new Set(newSubscribeEvents.map(e => e.x_uid))];

    // 3. æ´»è·ƒç”¨æˆ·ï¼ˆå½“æ—¥æœ‰ç™»å½•æˆ–è®¿é—®äº‹ä»¶ï¼‰
    const activeEvents = await eventsCollection.find({ date: targetDate }).toArray();
    const activeUserList = [...new Set(activeEvents.map(e => e.x_uid))];

    // 4. ç•™å­˜ç”¨æˆ·ï¼ˆæ˜¨æ—¥æ³¨å†Œï¼Œä»Šæ—¥ç™»å½•ï¼‰
    const yesterdayRegisters = await summaryCollection.find({ registerDate: yesterday }).toArray();
    const yesterdayRegisterUids = yesterdayRegisters.map(u => u.x_uid);

    const todayLogins = await eventsCollection
      .find({ date: targetDate, eventType: 'login', x_uid: { $in: yesterdayRegisterUids } })
      .toArray();
    const retainedUserList = [...new Set(todayLogins.map(e => e.x_uid))];

    // 5. æµå¤±ç”¨æˆ·ï¼ˆè¿‡å» 30 å¤©æœªç™»å½•ï¼‰
    const churnedUsers = await summaryCollection
      .find({
        lastLoginDate: { $lt: thirtyDaysAgo },
        status: 'active',
      })
      .toArray();
    const churnedUserList = churnedUsers.map(u => u.x_uid);

    // æ›´æ–°æµå¤±ç”¨æˆ·çŠ¶æ€
    await summaryCollection.updateMany(
      { x_uid: { $in: churnedUserList } },
      { $set: { status: 'churned', updatedAt: new Date() } },
    );

    // 6. å›æµç”¨æˆ·ï¼ˆä»Šæ—¥ç™»å½•ï¼Œä½†è¿‡å» 30 å¤©æœªç™»å½•ï¼‰
    const returnedCandidates = await summaryCollection
      .find({
        lastLoginDate: { $gte: targetDate },
        status: 'churned',
      })
      .toArray();
    const returnedUserList = returnedCandidates.map(u => u.x_uid);

    // 7. ç´¯è®¡æ³¨å†Œç”¨æˆ·æ•°
    const totalRegisters = await summaryCollection.countDocuments({});

    // 8. ç´¯è®¡è®¢é˜…ç”¨æˆ·æ•°
    const totalSubscribers = await summaryCollection.countDocuments({
      isSubscriber: true,
    });

    // 9. ä¿å­˜ç”¨æˆ·æ´»åŠ¨æ˜ç»†ï¼ˆé‡è¦ï¼šç”¨æˆ·åˆ—è¡¨å­˜å‚¨åˆ°ç‹¬ç«‹è¡¨ä¸­ï¼‰
    await this.saveUserActivityDetails(targetDate, {
      newRegisterUsers,
      newSubscriberUsers,
      activeUserList,
      retainedUserList,
      churnedUserList,
      returnedUserList,
    });

    // 10. å›½å®¶åˆ†å¸ƒç»Ÿè®¡
    const registerCountryStats = this.calculateCountryStats(newRegisterEvents);
    const subscriberCountryStats = this.calculateCountryStats(newSubscribeEvents);

    // 11. è®¾å¤‡ç±»å‹ç»Ÿè®¡
    const registerDeviceStats = this.calculateDeviceStats(newRegisterEvents);
    const subscriberDeviceStats = this.calculateDeviceStats(newSubscribeEvents);

    // 12. æ¥æºç»Ÿè®¡
    const refererStats = await this.calculateRefererStats(targetDate);

    // è®¡ç®—å„é¡¹æ¯”ç‡
    const retentionRate =
      yesterdayRegisterUids.length > 0
        ? (retainedUserList.length / yesterdayRegisterUids.length) * 100
        : 0;

    const churnRate = totalRegisters > 0 ? (churnedUserList.length / totalRegisters) * 100 : 0;

    const returnRate =
      churnedUsers.length > 0 ? (returnedUserList.length / churnedUsers.length) * 100 : 0;

    // æ³¨æ„ï¼šè¿”å›çš„æ—¥æŠ¥è¡¨ä¸å†åŒ…å«ç”¨æˆ·åˆ—è¡¨
    return {
      date: targetDate,
      newRegisters: newRegisterUsers.length,
      newSubscribers: newSubscriberUsers.length,
      activeUsers: activeUserList.length,
      retainedUsers: retainedUserList.length,
      retentionRate,
      churnedUsers: churnedUserList.length,
      churnRate,
      returnedUsers: returnedUserList.length,
      returnRate,
      totalRegisters,
      totalSubscribers,
      registerCountryStats,
      subscriberCountryStats,
      registerDeviceStats,
      subscriberDeviceStats,
      ...refererStats,
      createdAt: new Date(),
      updatedAt: new Date(),
    } as UserActivityDailyMongo;
  }

  /**
   * ä¿å­˜ç”¨æˆ·æ´»åŠ¨æ˜ç»†åˆ°ç‹¬ç«‹è¡¨
   * è§£å†³ç™¾ä¸‡çº§ç”¨æˆ·åœºæ™¯ä¸‹ï¼Œæ—¥æŠ¥è¡¨æ–‡æ¡£è¿‡å¤§çš„é—®é¢˜
   */
  private async saveUserActivityDetails(
    targetDate: string,
    userLists: {
      newRegisterUsers: string[];
      newSubscriberUsers: string[];
      activeUserList: string[];
      retainedUserList: string[];
      churnedUserList: string[];
      returnedUserList: string[];
    },
  ): Promise<void> {
    if (!this.mongoDb) {
      throw new Error('MongoDB è¿æ¥æœªå»ºç«‹');
    }

    const detailCollection =
      this.mongoDb.collection<UserActivityDetailMongo>('user_activity_detail');
    const summaryCollection =
      this.mongoDb.collection<UserActivitySummaryMongo>('user_activity_summary');

    // å…ˆåˆ é™¤å½“å¤©çš„æ—§æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    await detailCollection.deleteMany({ date: targetDate });

    // æ”¶é›†æ‰€æœ‰ç”¨æˆ·åŠå…¶æ´»åŠ¨ç±»å‹
    const userActivityMap = new Map<string, Set<string>>();

    // è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ ç”¨æˆ·æ´»åŠ¨
    const addUserActivity = (users: string[], activityType: string) => {
      for (const uid of users) {
        if (!userActivityMap.has(uid)) {
          userActivityMap.set(uid, new Set());
        }
        userActivityMap.get(uid)!.add(activityType);
      }
    };

    addUserActivity(userLists.newRegisterUsers, 'new_register');
    addUserActivity(userLists.newSubscriberUsers, 'new_subscriber');
    addUserActivity(userLists.activeUserList, 'active');
    addUserActivity(userLists.retainedUserList, 'retained');
    addUserActivity(userLists.churnedUserList, 'churned');
    addUserActivity(userLists.returnedUserList, 'returned');

    // æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·æ±‡æ€»ä¿¡æ¯ï¼ˆè·å–å›½å®¶ã€è®¾å¤‡ç­‰ä¿¡æ¯ï¼‰
    const allUids = Array.from(userActivityMap.keys());
    const userSummaries = await summaryCollection.find({ x_uid: { $in: allUids } }).toArray();
    const summaryMap = new Map(userSummaries.map(u => [u.x_uid, u]));

    // æ„å»ºæ˜ç»†æ•°æ®
    const details: Omit<UserActivityDetailMongo, '_id'>[] = [];

    for (const [uid, activityTypes] of userActivityMap.entries()) {
      const summary = summaryMap.get(uid);

      details.push({
        date: targetDate,
        x_uid: uid,
        activityTypes: Array.from(activityTypes) as any,
        countryCode: summary?.registerCountry,
        deviceType: summary?.registerDevice,
        refererDomain: summary?.registerRefererDomain,
        refererType: undefined, // å¯ä»¥ä» summary æ‰©å±•
        createdAt: new Date(),
      });
    }

    // æ‰¹é‡æ’å…¥ï¼ˆåˆ†æ‰¹æ¬¡ï¼Œé¿å…å•æ¬¡æ’å…¥è¿‡å¤šï¼‰
    const batchSize = 10000;
    for (let i = 0; i < details.length; i += batchSize) {
      const batch = details.slice(i, i + batchSize);
      await detailCollection.insertMany(batch as any);
    }

    logger.info(`ç”¨æˆ·æ´»åŠ¨æ˜ç»†å·²ä¿å­˜: ${details.length} æ¡è®°å½•`);
  }

  /**
   * è®¡ç®—å›½å®¶åˆ†å¸ƒç»Ÿè®¡
   */
  private calculateCountryStats(events: UserEventMongo[]): {
    [countryCode: string]: { count: number; percentage: number };
  } {
    const countryMap = new Map<string, number>();

    for (const event of events) {
      const country = event.geolocation?.countryCode || 'Unknown';
      countryMap.set(country, (countryMap.get(country) || 0) + 1);
    }

    const total = events.length;
    const stats: any = {};

    for (const [country, count] of countryMap.entries()) {
      stats[country] = {
        count,
        percentage: total > 0 ? (count / total) * 100 : 0,
      };
    }

    return stats;
  }

  /**
   * è®¡ç®—è®¾å¤‡ç±»å‹ç»Ÿè®¡
   */
  private calculateDeviceStats(events: UserEventMongo[]): {
    [deviceType: string]: { count: number; percentage: number };
  } {
    const deviceMap = new Map<string, number>();

    for (const event of events) {
      const device = event.userAgentInfo?.deviceType || 'Unknown';
      deviceMap.set(device, (deviceMap.get(device) || 0) + 1);
    }

    const total = events.length;
    const stats: any = {};

    for (const [device, count] of deviceMap.entries()) {
      stats[device] = {
        count,
        percentage: total > 0 ? (count / total) * 100 : 0,
      };
    }

    return stats;
  }

  /**
   * è®¡ç®—æ¥æºç»Ÿè®¡
   */
  private async calculateRefererStats(targetDate: string): Promise<any> {
    if (!this.mongoDb) {
      throw new Error('MongoDB è¿æ¥æœªå»ºç«‹');
    }

    const eventsCollection = this.mongoDb.collection<UserEventMongo>('user_events');

    // æŒ‰åŸŸåç»Ÿè®¡
    const domainPipeline = [
      { $match: { date: targetDate, refererDomain: { $exists: true, $ne: null } } },
      {
        $group: {
          _id: '$refererDomain',
          userCount: { $addToSet: '$x_uid' },
          registerCount: {
            $sum: { $cond: [{ $eq: ['$eventType', 'register'] }, 1, 0] },
          },
          subscribeCount: {
            $sum: { $cond: [{ $eq: ['$eventType', 'subscribe'] }, 1, 0] },
          },
        },
      },
      {
        $project: {
          domain: '$_id',
          userCount: { $size: '$userCount' },
          registerCount: 1,
          subscribeCount: 1,
          registerConversionRate: {
            $multiply: [{ $divide: ['$registerCount', { $size: '$userCount' }] }, 100],
          },
          subscribeConversionRate: {
            $multiply: [{ $divide: ['$subscribeCount', { $size: '$userCount' }] }, 100],
          },
        },
      },
    ];

    const domainResults = await eventsCollection.aggregate(domainPipeline).toArray();

    const refererDomainStats: any = {};
    for (const result of domainResults) {
      refererDomainStats[result.domain] = {
        userCount: result.userCount,
        registerConversionRate: result.registerConversionRate || 0,
        subscribeConversionRate: result.subscribeConversionRate || 0,
      };
    }

    // æŒ‰ URL ç»Ÿè®¡ï¼ˆTop 100ï¼‰
    const urlPipeline = [
      { $match: { date: targetDate, referer: { $exists: true, $ne: null } } },
      {
        $group: {
          _id: '$referer',
          userCount: { $addToSet: '$x_uid' },
          registerCount: {
            $sum: { $cond: [{ $eq: ['$eventType', 'register'] }, 1, 0] },
          },
          subscribeCount: {
            $sum: { $cond: [{ $eq: ['$eventType', 'subscribe'] }, 1, 0] },
          },
        },
      },
      {
        $project: {
          url: '$_id',
          userCount: { $size: '$userCount' },
          registerCount: 1,
          subscribeCount: 1,
        },
      },
      { $sort: { userCount: -1 } },
      { $limit: 100 },
    ];

    const urlResults = await eventsCollection.aggregate(urlPipeline).toArray();

    // æŒ‰æ¥æºç±»å‹ç»Ÿè®¡
    const typeStats = {
      direct: 0,
      search: 0,
      social: 0,
      internal: 0,
      external: 0,
    };

    const typeResults = await eventsCollection.find({ date: targetDate }).toArray();

    for (const event of typeResults) {
      const type = event.refererType || 'direct';
      if (type in typeStats) {
        typeStats[type as keyof typeof typeStats]++;
      }
    }

    return {
      refererDomainStats,
      refererUrlStats: urlResults,
      refererTypeStats: typeStats,
    };
  }

  /**
   * ä¿å­˜æ—¥æŠ¥è¡¨
   */
  private async saveDailyReport(report: UserActivityDailyMongo): Promise<void> {
    if (!this.mongoDb) {
      throw new Error('MongoDB è¿æ¥æœªå»ºç«‹');
    }

    const collection = this.mongoDb.collection<UserActivityDailyMongo>('user_activity_daily');

    await collection.replaceOne({ date: report.date }, report as any, { upsert: true });

    logger.info(`ç”¨æˆ·æ´»åŠ¨æ—¥æŠ¥è¡¨å·²ä¿å­˜: ${report.date}`);
  }

  /**
   * æ‰§è¡Œç”¨æˆ·æ´»åŠ¨åˆ†æ
   */
  async executeAnalysis(): Promise<void> {
    const targetDate = getCurrentDate();
    // const targetDate = '2025-11-27'; // æµ‹è¯•ç”¨

    logger.info(`å¼€å§‹æ‰§è¡Œç”¨æˆ·æ´»åŠ¨åˆ†æ: ${targetDate}`);

    await this.connectToMongoDB();

    try {
      // 1. æ›´æ–°ç”¨æˆ·æ±‡æ€»è¡¨
      await this.updateUserSummary(targetDate);

      // 2. è®¡ç®—æ—¥æŠ¥è¡¨æŒ‡æ ‡ï¼ˆå†…éƒ¨ä¼šåŒæ—¶ä¿å­˜ç”¨æˆ·æ˜ç»†åˆ°ç‹¬ç«‹è¡¨ï¼‰
      const dailyReport = await this.calculateDailyMetrics(targetDate);

      // 3. ä¿å­˜æ—¥æŠ¥è¡¨ï¼ˆä»…åŒ…å«èšåˆæŒ‡æ ‡ï¼‰
      await this.saveDailyReport(dailyReport);

      logger.info(`ç”¨æˆ·æ´»åŠ¨åˆ†æå®Œæˆ: ${targetDate}`);
      logger.info(`  - æ–°å¢æ³¨å†Œ: ${dailyReport.newRegisters}`);
      logger.info(`  - æ–°å¢è®¢é˜…: ${dailyReport.newSubscribers}`);
      logger.info(`  - æ´»è·ƒç”¨æˆ·: ${dailyReport.activeUsers}`);
      logger.info(
        `  - ç•™å­˜ç”¨æˆ·: ${dailyReport.retainedUsers} (${dailyReport.retentionRate.toFixed(2)}%)`,
      );
      logger.info(
        `  - æµå¤±ç”¨æˆ·: ${dailyReport.churnedUsers} (${dailyReport.churnRate.toFixed(2)}%)`,
      );
      logger.info(
        `  - å›æµç”¨æˆ·: ${dailyReport.returnedUsers} (${dailyReport.returnRate.toFixed(2)}%)`,
      );
      logger.info(`ğŸ’¡ ç”¨æˆ·æ˜ç»†å·²ä¿å­˜è‡³ user_activity_detail è¡¨ï¼Œæ”¯æŒåˆ†é¡µæŸ¥è¯¢`);
    } finally {
      await this.closeConnections();
    }
  }
}

/**
 * ä¸»æ‰§è¡Œå‡½æ•°
 */
async function main(): Promise<void> {
  const processor = new UserActivityAnalysisProcessor();
  await processor.executeAnalysis();
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬ï¼Œåˆ™æ‰§è¡Œä¸»å‡½æ•°
if (require.main === module) {
  runWithLock('user_activity_analysis', main)
    .then(() => {
      logger.info('ç”¨æˆ·æ´»åŠ¨åˆ†æä»»åŠ¡æ‰§è¡Œå®Œæˆ');
      process.exit(0);
    })
    .catch(error => {
      logger.error('ç”¨æˆ·æ´»åŠ¨åˆ†æä»»åŠ¡æ‰§è¡Œå¤±è´¥:', error);
      process.exit(1);
    });
}

export { UserActivityAnalysisProcessor, main };
```

#### 4.3 å®šæ—¶ä»»åŠ¡é…ç½® (æ–°å»º 13_user_activity_analysis.ts)

```typescript
// src/cron/jobs/13_user_activity_analysis.ts

import { CronManager } from '@/cron/CronManager';
import { logger } from '@/utils/logger';
import { runWithLock } from '@/utils/task-lock';
import { main as executeUserActivityAnalysis } from '@/logic/13_user_activity_analysis';

/**
 * ç”¨æˆ·æ´»åŠ¨åˆ†æå®šæ—¶ä»»åŠ¡
 * æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œï¼Œåˆ†æå‰ä¸€å¤©çš„ç”¨æˆ·æ´»åŠ¨æ•°æ®
 */
export async function setupUserActivityAnalysisJob(): Promise<void> {
  const taskName = 'user_activity_analysis';

  // æ¯å¤©å‡Œæ™¨ 2:00 æ‰§è¡Œ
  CronManager.registerJob(taskName, '0 2 * * *', async () => {
    try {
      await runWithLock(taskName, executeUserActivityAnalysis);
    } catch (error) {
      logger.error('ç”¨æˆ·æ´»åŠ¨åˆ†æä»»åŠ¡æ‰§è¡Œå¤±è´¥:', error);
    }
  });
}
```

#### 4.4 ä¸»å…¥å£æ–‡ä»¶æ›´æ–° (ä¿®æ”¹ index.ts)

```typescript
// src/index.ts ä¸­æ·»åŠ 

import { setupUserActivityAnalysisJob } from '@/cron/jobs/13_user_activity_analysis';

async function main(): Promise<void> {
  try {
    // ... ç°æœ‰ä»»åŠ¡ ...

    // ç”¨æˆ·æ´»åŠ¨åˆ†æ
    await setupUserActivityAnalysisJob();

    logger.info('æ‰€æœ‰å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨');
  } catch (error) {
    logger.error('åº”ç”¨ç¨‹åºå¯åŠ¨å¤±è´¥:', error);
    process.exit(1);
  }
}
```

#### 4.5 ç±»å‹å®šä¹‰æ›´æ–° (ä¿®æ”¹ mongo.ts)

å°†ä¸Šé¢å®šä¹‰çš„ä¸‰ä¸ªæ–°æ¥å£æ·»åŠ åˆ° `src/types/mongo.ts` æ–‡ä»¶ä¸­ã€‚

#### 4.6 å·¥å…·å‡½æ•° (æ–°å»ºæˆ–ä¿®æ”¹ date-utils.ts)

```typescript
// src/utils/date-utils.ts ä¸­æ·»åŠ 

/**
 * è·å–å‰ä¸€å¤©çš„æ—¥æœŸ
 */
export function getPreviousDate(dateString: string): string {
  const date = new Date(dateString);
  date.setDate(date.getDate() - 1);
  return date.toISOString().split('T')[0];
}

/**
 * è·å– N å¤©å‰çš„æ—¥æœŸ
 */
export function getDateDaysAgo(dateString: string, days: number): string {
  const date = new Date(dateString);
  date.setDate(date.getDate() - days);
  return date.toISOString().split('T')[0];
}
```

### ğŸ”Œ äº”ã€API æ¥å£è®¾è®¡ç¤ºä¾‹

#### 5.1 æŸ¥è¯¢æ—¥æŠ¥è¡¨ API

```typescript
// GET /api/user-activity/daily?date=2025-11-27
async function getUserActivityDaily(date: string) {
  const daily = await db.collection('user_activity_daily').findOne({ date });
  return {
    code: 0,
    data: {
      date: daily.date,
      metrics: {
        newRegisters: daily.newRegisters,
        newSubscribers: daily.newSubscribers,
        activeUsers: daily.activeUsers,
        retainedUsers: daily.retainedUsers,
        retentionRate: daily.retentionRate,
        churnedUsers: daily.churnedUsers,
        churnRate: daily.churnRate,
        returnedUsers: daily.returnedUsers,
        returnRate: daily.returnRate,
      },
      countryStats: daily.registerCountryStats,
      deviceStats: daily.registerDeviceStats,
      refererStats: daily.refererDomainStats,
    },
  };
}
```

#### 5.2 æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ APIï¼ˆåˆ†é¡µï¼‰

```typescript
// GET /api/user-activity/users?date=2025-11-27&type=new_register&page=1&pageSize=100
async function getUserActivityList(
  date: string,
  activityType: string,
  page: number = 1,
  pageSize: number = 100,
) {
  const skip = (page - 1) * pageSize;

  const [users, total] = await Promise.all([
    db
      .collection('user_activity_detail')
      .find({ date, activityTypes: activityType })
      .skip(skip)
      .limit(pageSize)
      .toArray(),
    db.collection('user_activity_detail').countDocuments({ date, activityTypes: activityType }),
  ]);

  return {
    code: 0,
    data: {
      list: users,
      pagination: {
        page,
        pageSize,
        total,
        totalPages: Math.ceil(total / pageSize),
      },
    },
  };
}
```

#### 5.3 æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ… API

```typescript
// GET /api/user-activity/user/:uid
async function getUserActivitySummary(uid: string) {
  const [summary, recentActivities] = await Promise.all([
    db.collection('user_activity_summary').findOne({ x_uid: uid }),
    db
      .collection('user_activity_detail')
      .find({ x_uid: uid })
      .sort({ date: -1 })
      .limit(30)
      .toArray(),
  ]);

  return {
    code: 0,
    data: {
      uid: summary.x_uid,
      registerDate: summary.registerDate,
      firstSubscribeDate: summary.firstSubscribeDate,
      status: summary.status,
      totalLoginDays: summary.totalLoginDays,
      isSubscriber: summary.isSubscriber,
      profile: {
        country: summary.registerCountry,
        device: summary.registerDevice,
        referer: summary.registerRefererDomain,
      },
      recentActivities: recentActivities.map(a => ({
        date: a.date,
        types: a.activityTypes,
      })),
    },
  };
}
```

#### 5.4 å¯¼å‡ºç”¨æˆ·åˆ—è¡¨ API

```typescript
// POST /api/user-activity/export
async function exportUserList(date: string, activityType: string) {
  // æµå¼å¯¼å‡ºï¼Œé¿å…å†…å­˜æº¢å‡º
  const cursor = db
    .collection('user_activity_detail')
    .find({ date, activityTypes: activityType })
    .stream();

  // ç”Ÿæˆ CSV æ–‡ä»¶
  const csvStream = csv.format({ headers: true });

  cursor.on('data', doc => {
    csvStream.write({
      uid: doc.x_uid,
      date: doc.date,
      country: doc.countryCode,
      device: doc.deviceType,
    });
  });

  cursor.on('end', () => {
    csvStream.end();
  });

  return csvStream;
}
```

### ğŸ“ å…­ã€å‰ç«¯åŸ‹ç‚¹å®ç°å»ºè®®

#### 6.1 æ³¨å†Œäº‹ä»¶åŸ‹ç‚¹

```javascript
// ç”¨æˆ·æ³¨å†ŒæˆåŠŸåè°ƒç”¨
async function trackRegister(userId) {
  await fetch('/api/track/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      uid: userId,
      link_id: 'register_page',
      timestamp: Date.now(),
    }),
  });
}
```

#### 6.2 è®¢é˜…äº‹ä»¶åŸ‹ç‚¹

```javascript
// ç”¨æˆ·è®¢é˜…æˆåŠŸåè°ƒç”¨
async function trackSubscribe(userId, plan, duration) {
  await fetch('/api/track/subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      uid: userId,
      link_id: 'subscribe',
      plan: plan,
      duration: duration,
      timestamp: Date.now(),
    }),
  });
}
```

#### 6.3 ç™»å½•äº‹ä»¶åŸ‹ç‚¹

```javascript
// ç”¨æˆ·ç™»å½•æˆåŠŸåè°ƒç”¨
async function trackLogin(userId) {
  await fetch('/api/track/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      uid: userId,
      link_id: 'login',
      timestamp: Date.now(),
    }),
  });
}
```

### ğŸš€ ä¸ƒã€éƒ¨ç½²æ­¥éª¤

1. **æ·»åŠ ç±»å‹å®šä¹‰**ï¼šåœ¨ `src/types/mongo.ts` ä¸­æ·»åŠ å››ä¸ªæ–°æ¥å£
   - `UserEventMongo` - ç”¨æˆ·äº‹ä»¶è¡¨
   - `UserActivityDailyMongo` - ç”¨æˆ·æ´»åŠ¨æ—¥æŠ¥è¡¨ï¼ˆåˆ é™¤ç”¨æˆ·åˆ—è¡¨å­—æ®µï¼‰
   - `UserActivityDetailMongo` - ç”¨æˆ·æ´»åŠ¨æ˜ç»†è¡¨ï¼ˆæ–°å¢ï¼‰
   - `UserActivitySummaryMongo` - ç”¨æˆ·æ´»åŠ¨æ±‡æ€»è¡¨

2. **å®ç°æ—¥å¿—åŒæ­¥å¢å¼º**ï¼šä¿®æ”¹ `src/logic/1_logs_sync.ts`
   - å¢åŠ äº‹ä»¶è¯†åˆ«é€»è¾‘
   - ä¿å­˜åˆ° `user_events` é›†åˆ

3. **åˆ›å»ºåˆ†æé€»è¾‘**ï¼šæ–°å»º `src/logic/13_user_activity_analysis.ts`
   - å®ç°ç”¨æˆ·æ±‡æ€»è¡¨æ›´æ–°
   - å®ç°æ—¥æŠ¥è¡¨æŒ‡æ ‡è®¡ç®—
   - **é‡ç‚¹ï¼šå®ç° `saveUserActivityDetails` æ–¹æ³•ï¼ˆä¿å­˜æ˜ç»†è¡¨ï¼‰**

4. **é…ç½®å®šæ—¶ä»»åŠ¡**ï¼šæ–°å»º `src/cron/jobs/13_user_activity_analysis.ts`
   - è®¾ç½®æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œ

5. **æ›´æ–°ä¸»å…¥å£**ï¼šä¿®æ”¹ `src/index.ts`
   - æ³¨å†Œç”¨æˆ·æ´»åŠ¨åˆ†æä»»åŠ¡

6. **æ·»åŠ å·¥å…·å‡½æ•°**ï¼šæ›´æ–° `src/utils/date-utils.ts`
   - `getPreviousDate` - è·å–å‰ä¸€å¤©æ—¥æœŸ
   - `getDateDaysAgo` - è·å– N å¤©å‰æ—¥æœŸ

7. **ç¼–è¯‘å’Œéƒ¨ç½²**ï¼š

   ```bash
   npm run build
   npm run pm2:restart
   ```

8. **éªŒè¯éƒ¨ç½²**ï¼š

   ```bash
   # æ£€æŸ¥ç´¢å¼•åˆ›å»º
   mongosh --eval "db.user_activity_detail.getIndexes()"

   # æŸ¥çœ‹æ—¥å¿—
   pm2 logs
   ```

### ğŸ“Š å…«ã€æ•°æ®æŸ¥è¯¢ç¤ºä¾‹

#### 8.1 æ—¥æŠ¥è¡¨æŸ¥è¯¢ï¼ˆèšåˆæŒ‡æ ‡ï¼‰

```javascript
// æŸ¥è¯¢æŸå¤©çš„ç”¨æˆ·æ´»åŠ¨æŠ¥è¡¨ï¼ˆåªåŒ…å«ç»Ÿè®¡æ•°å­—ï¼Œä¸å«ç”¨æˆ·åˆ—è¡¨ï¼‰
db.user_activity_daily.findOne({ date: '2025-11-27' });

// æŸ¥è¯¢è¿‡å» 7 å¤©çš„ç•™å­˜è¶‹åŠ¿
db.user_activity_daily
  .find({ date: { $gte: '2025-11-20', $lte: '2025-11-27' } })
  .sort({ date: 1 })
  .projection({ date: 1, retainedUsers: 1, retentionRate: 1, activeUsers: 1 });

// æŸ¥è¯¢è¿‡å» 30 å¤©çš„æ–°å¢æ³¨å†Œè¶‹åŠ¿
db.user_activity_daily
  .find({ date: { $gte: '2025-10-28' } })
  .sort({ date: 1 })
  .projection({ date: 1, newRegisters: 1, newSubscribers: 1 });
```

#### 8.2 æ˜ç»†è¡¨æŸ¥è¯¢ï¼ˆç”¨æˆ·åˆ—è¡¨ï¼‰

```javascript
// æŸ¥è¯¢æŸå¤©çš„æ–°æ³¨å†Œç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
db.user_activity_detail
  .find(
    { date: '2025-11-27', activityTypes: 'new_register' },
    { x_uid: 1, countryCode: 1, deviceType: 1 },
  )
  .skip(0)
  .limit(100);

// ç»Ÿè®¡æŸå¤©æ–°æ³¨å†Œç”¨æˆ·æ•°
db.user_activity_detail.countDocuments({
  date: '2025-11-27',
  activityTypes: 'new_register',
});

// æŸ¥è¯¢æŸå¤©æµå¤±ç”¨æˆ·ä¸­æ¥è‡ªç¾å›½çš„ç”¨æˆ·ï¼ˆåˆ†é¡µï¼‰
db.user_activity_detail
  .find({
    date: '2025-11-27',
    activityTypes: 'churned',
    countryCode: 'US',
  })
  .skip(0)
  .limit(100);

// æŸ¥è¯¢æŸå¤©æ´»è·ƒä¸”å·²è®¢é˜…çš„ç”¨æˆ·
db.user_activity_detail.find({
  date: '2025-11-27',
  activityTypes: { $all: ['active', 'new_subscriber'] },
});

// æŸ¥è¯¢æŸå¤©æŒ‰å›½å®¶åˆ†ç»„çš„æ–°æ³¨å†Œç”¨æˆ·æ•°
db.user_activity_detail.aggregate([
  { $match: { date: '2025-11-27', activityTypes: 'new_register' } },
  { $group: { _id: '$countryCode', count: { $sum: 1 } } },
  { $sort: { count: -1 } },
]);
```

#### 8.3 æ±‡æ€»è¡¨æŸ¥è¯¢ï¼ˆç”¨æˆ·ç”»åƒï¼‰

```javascript
// æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ´»åŠ¨æ±‡æ€»
db.user_activity_summary.findOne({ x_uid: 'user_123' });

// æŸ¥è¯¢æµå¤±ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
db.user_activity_summary.find({ status: 'churned' }).sort({ lastLoginDate: 1 }).skip(0).limit(100);

// æŸ¥è¯¢æŸå¤©æ³¨å†Œçš„æ‰€æœ‰ç”¨æˆ·
db.user_activity_summary.find({ registerDate: '2025-11-27' });

// æŸ¥è¯¢æœ€è¿‘ 30 å¤©æœªç™»å½•çš„æ´»è·ƒç”¨æˆ·ï¼ˆå³å°†æµå¤±ï¼‰
const thirtyDaysAgo = '2025-10-28';
db.user_activity_summary.find({
  status: 'active',
  lastLoginDate: { $lt: thirtyDaysAgo },
});

// ç»Ÿè®¡å„å›½çš„è®¢é˜…ç”¨æˆ·æ•°
db.user_activity_summary.aggregate([
  { $match: { isSubscriber: true } },
  { $group: { _id: '$registerCountry', count: { $sum: 1 } } },
  { $sort: { count: -1 } },
]);
```

#### 8.4 å¤æ‚æŸ¥è¯¢ç¤ºä¾‹

```javascript
// æŸ¥è¯¢æŸå¤©æ–°æ³¨å†Œä¸”å½“å¤©å°±è®¢é˜…çš„ç”¨æˆ·ï¼ˆé«˜ä»·å€¼ç”¨æˆ·ï¼‰
db.user_activity_detail.find({
  date: '2025-11-27',
  activityTypes: { $all: ['new_register', 'new_subscriber'] },
});

// æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ´»åŠ¨å†å²ï¼ˆæœ€è¿‘ 30 å¤©ï¼‰
db.user_activity_detail.find({ x_uid: 'user_123' }).sort({ date: -1 }).limit(30);

// ç»Ÿè®¡æœ€è¿‘ 7 å¤©æ¯å¤©çš„æ´»è·ƒç”¨æˆ·å›½å®¶åˆ†å¸ƒ
db.user_activity_detail.aggregate([
  {
    $match: {
      date: { $gte: '2025-11-20', $lte: '2025-11-27' },
      activityTypes: 'active',
    },
  },
  {
    $group: {
      _id: { date: '$date', country: '$countryCode' },
      count: { $sum: 1 },
    },
  },
  { $sort: { '_id.date': 1, count: -1 } },
]);
```

### ğŸš€ ä¹ã€æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

#### 9.1 æ•°æ®åˆ†å±‚å­˜å‚¨ç­–ç•¥

**æ–¹æ¡ˆä¸‰çš„æ ¸å¿ƒä¼˜åŠ¿**ï¼š

| è¡¨å                  | æ•°æ®ç±»å‹ | æ–‡æ¡£å¤§å° | æŸ¥è¯¢é¢‘ç‡ | é€‚ç”¨åœºæ™¯           |
| --------------------- | -------- | -------- | -------- | ------------------ |
| user_activity_daily   | èšåˆæŒ‡æ ‡ | < 100KB  | é«˜é¢‘     | è¶‹åŠ¿åˆ†æã€å›¾è¡¨å±•ç¤º |
| user_activity_detail  | ç”¨æˆ·åˆ—è¡¨ | å¯æ§     | ä¸­é¢‘     | ç”¨æˆ·åˆ—è¡¨ã€æ˜ç»†æŸ¥è¯¢ |
| user_activity_summary | ç”¨æˆ·ç”»åƒ | å•æ¡å°   | é«˜é¢‘     | ç”¨æˆ·æŸ¥è¯¢ã€å®æ—¶è®¡ç®— |
| user_events           | åŸå§‹äº‹ä»¶ | æµ·é‡     | ä½é¢‘     | æ•°æ®å›æº¯ã€é‡æ–°è®¡ç®— |

#### 9.2 ç™¾ä¸‡çº§ç”¨æˆ·åœºæ™¯æ€§èƒ½å¯¹æ¯”

**å­˜å‚¨ç©ºé—´å¯¹æ¯”**ï¼š

```
åŸæ–¹æ¡ˆï¼ˆæ•°ç»„å­˜å‚¨ï¼‰:
- æ—¥æŠ¥è¡¨: 100ä¸‡ç”¨æˆ· Ã— 24å­—èŠ‚/UID Ã— 6ä¸ªæ•°ç»„ â‰ˆ 137MB/å¤©ï¼ˆè¶…é™ï¼ï¼‰
- é—®é¢˜: MongoDBå•æ–‡æ¡£é™åˆ¶16MBï¼Œæ— æ³•å­˜å‚¨

æ–¹æ¡ˆä¸‰ï¼ˆç‹¬ç«‹æ˜ç»†è¡¨ï¼‰:
- æ—¥æŠ¥è¡¨: < 100KB/å¤©ï¼ˆä»…ç»Ÿè®¡æ•°å­—ï¼‰
- æ˜ç»†è¡¨: 100ä¸‡ç”¨æˆ· Ã— ~100å­—èŠ‚ â‰ˆ 95MB/å¤©ï¼ˆå¯æ¥å—ï¼‰
- æ±‡æ€»è¡¨: 100ä¸‡ç”¨æˆ· Ã— ~200å­—èŠ‚ â‰ˆ 190MBï¼ˆå¢é‡æ›´æ–°ï¼‰
```

**æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”**ï¼š

```
åœºæ™¯1: æŸ¥è¯¢è¿‡å»30å¤©ç•™å­˜è¶‹åŠ¿
- åŸæ–¹æ¡ˆ: åŠ è½½30å¤©Ã—137MB = 4.1GBæ•°æ®ï¼ˆä¸å¯è¡Œï¼‰
- æ–¹æ¡ˆä¸‰: åŠ è½½30å¤©Ã—100KB = 3MBæ•°æ®ï¼ˆç§’çº§å“åº”ï¼‰

åœºæ™¯2: æŸ¥è¯¢æŸå¤©æ–°æ³¨å†Œç”¨æˆ·ï¼ˆåˆ†é¡µ100æ¡ï¼‰
- åŸæ–¹æ¡ˆ: éœ€åŠ è½½æ•´ä¸ªæ•°ç»„ï¼ˆ137MBï¼‰å†åˆ†é¡µ
- æ–¹æ¡ˆä¸‰: ç›´æ¥æŸ¥è¯¢æ˜ç»†è¡¨ï¼Œ100æ¡ â‰ˆ 10KBï¼ˆæ¯«ç§’çº§å“åº”ï¼‰

åœºæ™¯3: æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ´»åŠ¨å†å²
- åŸæ–¹æ¡ˆ: éœ€æ‰«ææ‰€æœ‰æ—¥æŠ¥è¡¨æ–‡æ¡£
- æ–¹æ¡ˆä¸‰: ç›´æ¥æŸ¥è¯¢æ˜ç»†è¡¨ï¼Œç´¢å¼•ä¼˜åŒ–ï¼ˆæ¯«ç§’çº§å“åº”ï¼‰
```

#### 9.3 è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

**1. æ•°æ®å½’æ¡£ç­–ç•¥**

```javascript
// å½’æ¡£90å¤©å‰çš„æ˜ç»†æ•°æ®åˆ°å†å²è¡¨
db.user_activity_detail.aggregate([
  { $match: { date: { $lt: '2025-08-28' } } },
  { $out: 'user_activity_detail_archive' },
]);

// åˆ é™¤å·²å½’æ¡£æ•°æ®
db.user_activity_detail.deleteMany({ date: { $lt: '2025-08-28' } });
```

**2. åˆ†ç‰‡ç­–ç•¥ï¼ˆè¶…å¤§è§„æ¨¡åœºæ™¯ï¼‰**

```javascript
// å¯ç”¨åˆ†ç‰‡ï¼ˆå½“å•æœºæ€§èƒ½ä¸è¶³æ—¶ï¼‰
sh.enableSharding('weblogs');
sh.shardCollection('weblogs.user_activity_detail', { date: 1, x_uid: 'hashed' });
```

**3. è¯»å†™åˆ†ç¦»**

```javascript
// ä½¿ç”¨ MongoDB å‰¯æœ¬é›†ï¼ŒæŸ¥è¯¢èµ°ä»èŠ‚ç‚¹
db.user_activity_detail.find({ date: '2025-11-27' }).readPref('secondaryPreferred');
```

**4. ç¼“å­˜çƒ­ç‚¹æ•°æ®**

```javascript
// ä½¿ç”¨ Redis ç¼“å­˜æœ€è¿‘7å¤©çš„æ—¥æŠ¥è¡¨æ•°æ®
const cacheKey = `user_activity_daily:${date}`;
let data = await redis.get(cacheKey);
if (!data) {
  data = await db.user_activity_daily.findOne({ date });
  await redis.setex(cacheKey, 3600 * 24, JSON.stringify(data));
}
```

#### 9.4 ç›‘æ§æŒ‡æ ‡

```javascript
// ç›‘æ§æ˜ç»†è¡¨æ–‡æ¡£æ•°é‡
db.user_activity_detail.countDocuments({});

// ç›‘æ§æ˜ç»†è¡¨å ç”¨ç©ºé—´
db.user_activity_detail.stats();

// ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ
db.user_activity_detail.aggregate([{ $indexStats: {} }]);

// æ…¢æŸ¥è¯¢åˆ†æ
db.setProfilingLevel(1, { slowms: 100 });
db.system.profile.find().sort({ ts: -1 }).limit(10);
```

### âœ… åã€æ€»ç»“

#### 10.1 æ–¹æ¡ˆä¸‰çš„æ ¸å¿ƒä¼˜åŠ¿

1. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒç™¾ä¸‡çº§ç”šè‡³åƒä¸‡çº§ç”¨æˆ·è§„æ¨¡
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆ†å±‚å­˜å‚¨ï¼ŒæŒ‰éœ€æŸ¥è¯¢ï¼Œé¿å…å¤§æ–‡æ¡£é—®é¢˜
3. **å­˜å‚¨é«˜æ•ˆ**ï¼šçªç ´å•æ–‡æ¡£16MBé™åˆ¶ï¼Œå­˜å‚¨ç©ºé—´å¯æ§
4. **æŸ¥è¯¢çµæ´»**ï¼šæ”¯æŒå¤šç»´åº¦æŸ¥è¯¢å’Œåˆ†é¡µï¼Œå“åº”é€Ÿåº¦å¿«
5. **å¯ç»´æŠ¤æ€§**ï¼šæ•°æ®ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†æ˜ï¼Œæ˜“äºæ‰©å±•

#### 10.2 æŠ€æœ¯äº®ç‚¹

- âœ… **æ•°æ®åˆ†å±‚**ï¼šæ—¥æŠ¥è¡¨ï¼ˆæŒ‡æ ‡ï¼‰+ æ˜ç»†è¡¨ï¼ˆåˆ—è¡¨ï¼‰+ æ±‡æ€»è¡¨ï¼ˆç”»åƒï¼‰
- âœ… **æ‰¹é‡å†™å…¥**ï¼šæ˜ç»†è¡¨ä½¿ç”¨æ‰¹é‡æ’å…¥ï¼Œæå‡å†™å…¥æ€§èƒ½
- âœ… **ç´¢å¼•ä¼˜åŒ–**ï¼šå¤šç»´åº¦å¤åˆç´¢å¼•ï¼Œæ”¯æŒé«˜æ•ˆæŸ¥è¯¢
- âœ… **åˆ†é¡µæ”¯æŒ**ï¼šé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
- âœ… **å†å²è¿½æº¯**ï¼šä¿ç•™åŸå§‹äº‹ä»¶æ•°æ®ï¼Œæ”¯æŒé‡æ–°è®¡ç®—

#### 10.3 å®æ–½æ­¥éª¤

1. **æ·»åŠ ç±»å‹å®šä¹‰**ï¼šåœ¨ `src/types/mongo.ts` ä¸­æ·»åŠ  `UserActivityDetailMongo` æ¥å£
2. **ä¿®æ”¹æ—¥æŠ¥è¡¨æ¥å£**ï¼šåˆ é™¤ `UserActivityDailyMongo` ä¸­çš„ç”¨æˆ·åˆ—è¡¨å­—æ®µ
3. **å®ç°æ—¥å¿—åŒæ­¥å¢å¼º**ï¼šä¿®æ”¹ `src/logic/1_logs_sync.ts`
4. **åˆ›å»ºåˆ†æé€»è¾‘**ï¼šæ–°å»º `src/logic/13_user_activity_analysis.ts`ï¼ˆåŒ…å«æ˜ç»†è¡¨ä¿å­˜é€»è¾‘ï¼‰
5. **é…ç½®å®šæ—¶ä»»åŠ¡**ï¼šæ–°å»º `src/cron/jobs/13_user_activity_analysis.ts`
6. **æ›´æ–°ä¸»å…¥å£**ï¼šä¿®æ”¹ `src/index.ts`
7. **æ·»åŠ å·¥å…·å‡½æ•°**ï¼šæ›´æ–° `src/utils/date-utils.ts`
8. **ç¼–è¯‘å’Œéƒ¨ç½²**

#### 10.4 åç»­ä¼˜åŒ–æ–¹å‘

- [ ] å®ç°æ•°æ®å½’æ¡£ç­–ç•¥ï¼ˆ90å¤©åå½’æ¡£ï¼‰
- [ ] æ·»åŠ  Redis ç¼“å­˜å±‚
- [ ] å®ç°å®æ—¶æ¨é€åŠŸèƒ½
- [ ] æ·»åŠ å¼‚å¸¸æ£€æµ‹å’Œå‘Šè­¦
- [ ] ä¼˜åŒ–æ‰¹é‡å†™å…¥æ€§èƒ½
- [ ] å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½

---

**æœ¬æ–¹æ¡ˆå·²é’ˆå¯¹ç™¾ä¸‡çº§ç”¨æˆ·åœºæ™¯è¿›è¡Œä¼˜åŒ–ï¼Œå¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ã€‚**
